<!DOCTYPE html>
<html>
<head>
    <title>Ride Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: white;
        }

        .hero {
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: auto 1fr;
            overflow-y: scroll;
            padding: 5px;
            padding-left: 20px;
            padding-right: 20px;
            width: 100%;
            background: rgb(250, 236, 255);
        }

        .hero-form {
            padding: 5px 5px;
        }

        .info {
            border-radius: 15px;
            padding-left: 12px;
            padding-right: 12px;
        }

        .info p {
            font-weight: 500;
            padding: 6px;
            width: 96%;
            border-radius: 8px;
        }

        .info p span {
            font-weight: 700;
        }

        .hero-left {
            border-radius: 12px;
            margin-top: 6px;
        }

        .hero-right {
            margin-top: 10px;
        }

        .hero-right #map {
            height: 95vh;
            width: 100%;
        }

        @media screen and (min-width: 768px) {
            .hero {
                grid-template-columns: calc(340px + 111px) 1fr;
            }

            .hero-left .hero-form {
                width: 90%;
                margin-top: 2px;
            }
        }

        .hero-left .hero-form h2 {
            font-size: 26px;
            font-weight: 700;
            padding-left: 10px;
            margin: 10px 0;
            color: rgb(255, 97, 40);
        }

        .hero-left .hero-form p {
            font-size: 17px;
            padding-left: 10px;
            margin: 2px 0;
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAvSl8hKmXkz9tE8ctzuXtRQz0Y2lUFknI&callback=initMap" async defer></script>
    <script>
        function initMap() {
            var driverLatLng = {lat: {{ driver_latitude }}, lng: {{ driver_longitude }}};
            var pickupLatLng = {lat: {{ pickup_latitude }}, lng: {{ pickup_longitude }}};

            var map = new google.maps.Map(document.getElementById('map'), {
                center: driverLatLng,
                zoom: 10
            });

            var carIcon = {
                url: "/static/car.png",
                scaledSize: new google.maps.Size(50, 36)
            };
            var manIcon = {
                url: "/static/man1.png",
                scaledSize: new google.maps.Size(60, 50)
            };

            var driverMarker = new google.maps.Marker({
                position: driverLatLng,
                map: map,
                icon: carIcon,
                title: 'Driver Location'
            });
            var pickupMarker = new google.maps.Marker({
                position: pickupLatLng,
                map: map,
                icon: manIcon,
                title: 'Pickup Location'
            });

            var directionsService = new google.maps.DirectionsService;
            var directionsDisplay = new google.maps.DirectionsRenderer({
                suppressMarkers: true
            });
            directionsDisplay.setMap(map);

            directionsService.route({
                origin: driverLatLng,
                destination: pickupLatLng,
                travelMode: 'DRIVING'
            }, function(response, status) {
                if (status === 'OK') {
                    directionsDisplay.setDirections(response);
                } else {
                    window.alert('Directions request failed due to ' + status);
                }
            });
        }

        initMap();

        function checkRideStatus() {
            fetch("{% url 'check_verification_status' ride_id=ride_id %}")
                .then(response => response.json())
                .then(data => {
                    if (data.is_verified) {
                        window.location.href = "{% url 'display_map' ride_id=ride_id %}";
                    }
                })
                .catch(error => console.error('Error checking verification status:', error));
        }

        setInterval(checkRideStatus, 5000);
    </script>
</head>
<body>
    <section class="hero">
        <div class="hero-left">
            <div class="hero-form">
                <h2>Booking Details</h2>
                <div class="info">
                    <p><span><i class="fa-solid fa-circle-dot"></i> Pickup:</span> {{ pickup }}</p>
                    <p><span><i class="fa-solid fa-location-dot"></i> Drop:</span> {{ drop }}</p>
                    <p><span><i class="fa-solid fa-clock"></i> Estimated Time:</span> {{ estimated_time }}</p>
                    <p><span><i class="fa-solid fa-route"></i> Estimated Distance:</span> {{ estimated_distance }}</p>
                    <p><span><i class="fa-solid fa-dollar-sign"></i> Fare:</span> â‚¹{{ fare }}</p>
                </div>
            </div>
            <div class="hero-form">
                <h2>Driver Details</h2>
                <div class="info">
                    <p><span>Driver Name:</span> {{ driver_name|title }}</p>
                    <p><span>Phone Number:</span> {{ phone_number }}</p>
                    <p><span>License Number:</span> {{ license_number }}</p>
                    <p><span>Number Plate:</span> {{ number_plate }}</p>
                    <p><span>Ambulance Type:</span> {{ ambulance_type }}</p>
                    <p><span>Driver's Estimated Time to Pickup:</span> {{ driver_est_time }}</p>
                    <p><span>Driver's Estimated Distance to Pickup:</span> {{ driver_est_distance }}</p>
                </div>
            </div>
                <!-- Google Maps Navigation Button (Visible only to the driver) -->
                {% if request.user.is_driver %}
                <a href="{{ google_maps_url }}" target="_blank">
                    <button type="button">Start Navigation</button>
                </a>
                {% endif %}
        </div>

        <div class="hero-right">
            <div id="map"></div>
        </div>
    </section>
</body>
</html>