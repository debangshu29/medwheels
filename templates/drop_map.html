<!DOCTYPE html>
<html>
<head>
    <title>Map with Pickup and Drop Locations</title>
    <style>
        #map {
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body>
    <h1>Map with Pickup and Drop Locations</h1>
    <div>
        <div class="hero-form">
            <h2>Drop-off Details</h2>
            <p><i class="fa-solid fa-circle-dot"></i> <span>Pickup Location:</span> {{ pickup }}</p>
            <p><i class="fa-solid fa-location-dot"></i> <span>Drop-off Location:</span> {{ drop }}</p>

            <!-- Google Maps Navigation Button (Visible only to the driver) -->
            {% if request.user.is_driver %}
            <a href="{{ google_maps_url }}" target="_blank">
                <button type="button">Start Navigation to Drop-off</button>
            </a>
            {% endif %}
        </div>
    </div>
    <div id="map"></div>

    <script>
        var map;
        var ambulanceMarker;
        var directionsRenderer;

        // Pass ride_id from Django template to JavaScript
        var ride_id = "{{ ride_id }}";  // Ensure ride_id is available

        function initMap() {
            // Pickup and drop locations
            var pickupLocation = {lat: {{ pickup_location.0 }}, lng: {{ pickup_location.1 }}};
            var dropLocation = {lat: {{ drop_location.0 }}, lng: {{ drop_location.1 }}};

            // Create a map centered at the pickup location
            map = new google.maps.Map(document.getElementById('map'), {
                center: pickupLocation,
                zoom: 12
            });

            // Create a marker for the drop location
            new google.maps.Marker({
                position: dropLocation,
                map: map,
                title: 'Drop Location'
            });

            // Initialize the directions renderer
            directionsRenderer = new google.maps.DirectionsRenderer({ map: map });

            // Create a marker for the ambulance
            ambulanceMarker = new google.maps.Marker({
                position: pickupLocation, // Start at pickup location
                map: map,
                title: 'Ambulance Location',
                icon: {
                    url: '/static/car.png', // Custom ambulance icon
                    scaledSize: new google.maps.Size(40, 40)
                }
            });

            // Calculate and display the initial route
            calculateAndDisplayRoute(pickupLocation, dropLocation);

            // Start updating the ambulance's location in real-time
            setInterval(updateAmbulanceLocation, 5000); // Adjust the interval as needed
        }

        function calculateAndDisplayRoute(origin, destination) {
            var directionsService = new google.maps.DirectionsService();
            directionsService.route({
                origin: origin,
                destination: destination,
                travelMode: 'DRIVING'
            }, function(response, status) {
                if (status === 'OK') {
                    directionsRenderer.setDirections(response);
                } else {
                    window.alert('Directions request failed due to ' + status);
                }
            });
        }

        function updateAmbulanceLocation() {
            fetch(`/get_driver_location/${ride_id}/`)
                .then(response => {
                    if (!response.ok) {
                        console.error('Network response was not ok', response.statusText);
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Driver location data received:', data);
                    if (data.latitude && data.longitude) {
                        var driverLatLng = {
                            lat: parseFloat(data.latitude),
                            lng: parseFloat(data.longitude)
                        };
                        ambulanceMarker.setPosition(driverLatLng);
                        // Re-center the map to the ambulance's current location
                        map.setCenter(driverLatLng);
                    } else {
                        console.error('Invalid driver location data.');
                    }
                })
                .catch(error => console.error('Error fetching driver location:', error));
        }

        // Initialize the map when the page loads
        window.onload = initMap;
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAvSl8hKmXkz9tE8ctzuXtRQz0Y2lUFknI&callback=initMap" async defer></script>
</body>
</html>
